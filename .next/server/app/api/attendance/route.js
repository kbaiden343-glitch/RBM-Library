"use strict";(()=>{var e={};e.id=996,e.ids=[996],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3669:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>m,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var r={};n.r(r),n.d(r,{GET:()=>u,POST:()=>l});var a=n(9303),s=n(8716),o=n(670),i=n(7070),c=n(2663);async function u(e){try{let{searchParams:t}=new URL(e.url),n=parseInt(t.get("page")||"1"),r=parseInt(t.get("limit")||"10"),a=t.get("memberId")||"",s=t.get("date")||"",o=(n-1)*r,u={};if(a&&(u.personId=a),s){let e=new Date(s),t=new Date(s);t.setDate(t.getDate()+1),u.checkInTime={gte:e,lt:t}}let[l,d]=await Promise.all([c._.attendance.findMany({where:u,skip:o,take:r,orderBy:{checkInTime:"desc"},include:{person:!0}}),c._.attendance.count({where:u})]);return i.NextResponse.json({attendance:l,pagination:{page:n,limit:r,total:d,pages:Math.ceil(d/r)}})}catch(e){return console.error("Get attendance error:",e),i.NextResponse.json({error:"Failed to fetch attendance"},{status:500})}}async function l(e){try{let{action:t,personId:n,memberId:r,visitorName:a,visitorEmail:s,visitorPhone:o}=await e.json();if("check-in"===t){if(n){let e=await c._.person.findUnique({where:{id:n}});if(!e)return i.NextResponse.json({error:"Person not found"},{status:404});if("ACTIVE"!==e.status)return i.NextResponse.json({error:"Person is not active"},{status:400});let t=new Date,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1);if(await c._.attendance.findFirst({where:{personId:n,checkInTime:{gte:r,lt:a},checkOutTime:null}}))return i.NextResponse.json({error:"Person is already checked in today"},{status:409});let s=await c._.attendance.create({data:{personId:n,isVisitor:"VISITOR"===e.personType},include:{person:!0}});return i.NextResponse.json(s,{status:201})}if(r){let e=await c._.person.findUnique({where:{id:r}});if(!e)return i.NextResponse.json({error:"Person not found"},{status:404});if("MEMBER"!==e.personType)return i.NextResponse.json({error:"Person is not a member"},{status:400});let t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1);if(await c._.attendance.findFirst({where:{personId:r,checkInTime:{gte:n,lt:a},checkOutTime:null}}))return i.NextResponse.json({error:"Member is already checked in today"},{status:409});let s=await c._.attendance.create({data:{personId:r,isVisitor:!1},include:{person:!0}});return i.NextResponse.json(s,{status:201})}{if(!a||!s)return i.NextResponse.json({error:"Visitor name and email are required"},{status:400});let e=await c._.attendance.create({data:{visitorName:a,visitorEmail:s,visitorPhone:o||null,isVisitor:!0}});return i.NextResponse.json(e,{status:201})}}if("check-out"!==t)return i.NextResponse.json({error:'Invalid action. Use "check-in" or "check-out"'},{status:400});{let e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1),o={checkInTime:{gte:t,lt:a},checkOutTime:null};if(n)o.personId=n;else if(r)o.personId=r;else{if(!s)return i.NextResponse.json({error:"Person ID, Member ID, or visitor email is required for check-out"},{status:400});o.visitorEmail=s,o.isVisitor=!0}let u=await c._.attendance.findFirst({where:o,include:{person:!0}});if(!u)return i.NextResponse.json({error:"No active check-in found for today"},{status:404});let l=await c._.attendance.update({where:{id:u.id},data:{checkOutTime:new Date},include:{person:!0}});return i.NextResponse.json(l,{status:200})}}catch(e){return console.error("Attendance operation error:",e),i.NextResponse.json({error:"Failed to process attendance"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/attendance/route",pathname:"/api/attendance",filename:"route",bundlePath:"app/api/attendance/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\Library Project\\app\\api\\attendance\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:g}=d,m="/api/attendance/route";function f(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},2663:(e,t,n)=>{let r;n.d(t,{_:()=>r});let a=require("@prisma/client"),s=globalThis,o=process.env.DATABASE_URL||process.env.POSTGRES_URL||process.env.POSTGRES_PRISMA_URL,i=o?`${o}?connection_limit=1&pool_timeout=20&connect_timeout=60&schema=public&pgbouncer=true&prepared_statements=false`:o;try{r=s.prisma??new a.PrismaClient({log:["error"],datasources:{db:{url:i}}})}catch(e){console.warn("Prisma client not available, using fallback:",e),r={}}}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[948,972],()=>n(3669));module.exports=r})();