"use strict";(()=>{var e={};e.id=11,e.ids=[11],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7654:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>h,patchFetch:()=>g,requestAsyncStorage:()=>u,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var a={};n.r(a),n.d(a,{GET:()=>d});var r=n(9303),i=n(8716),s=n(670),o=n(7070),c=n(2663);async function d(e){try{let t;let{searchParams:n}=new URL(e.url),a=n.get("period")||"week",r=n.get("startDate"),i=n.get("endDate"),s=new Date;if(r&&i)t={gte:new Date(r),lt:new Date(i)};else switch(a){case"week":let d=new Date(s);d.setDate(s.getDate()-7),t={gte:d,lt:s};break;case"month":let l=new Date(s);l.setMonth(s.getMonth()-1),t={gte:l,lt:s};break;case"year":let u=new Date(s);u.setFullYear(s.getFullYear()-1),t={gte:u,lt:s};break;default:let m=new Date(s);m.setDate(s.getDate()-7),t={gte:m,lt:s}}let p=await c._.attendance.count({where:{checkInTime:t}}),h=(await c._.attendance.groupBy({by:["checkInTime"],where:{checkInTime:t},_count:{id:!0},orderBy:{checkInTime:"asc"}})).reduce((e,t)=>{let n=new Date(t.checkInTime).toISOString().split("T")[0];return e[n]||(e[n]=0),e[n]+=t._count.id,e},{}),g=await c._.attendance.groupBy({by:["isVisitor"],where:{checkInTime:t},_count:{id:!0}}),w=await c._.attendance.groupBy({by:["personId","memberId"],where:{checkInTime:t,OR:[{personId:{not:null}},{memberId:{not:null}}]},_count:{id:!0},orderBy:{_count:{id:"desc"}},take:10}),k=w.filter(e=>e.personId).map(e=>e.personId),I=w.filter(e=>e.memberId).map(e=>e.memberId),[T,y]=await Promise.all([k.length>0?c._.person.findMany({where:{id:{in:k}},select:{id:!0,name:!0,email:!0,personType:!0}}):[],I.length>0?c._.member.findMany({where:{id:{in:I}},select:{id:!0,name:!0,email:!0}}):[]]),D=w.map(e=>{let t=T.find(t=>t.id===e.personId),n=y.find(t=>t.id===e.memberId);return{id:e.personId||e.memberId,name:t?.name||n?.name||"Unknown",email:t?.email||n?.email||"Unknown",type:t?.personType||"Member",visits:e._count.id}}),b=(await c._.attendance.findMany({where:{checkInTime:t},select:{checkInTime:!0}})).reduce((e,t)=>{let n=new Date(t.checkInTime).getHours();return e[n]=(e[n]||0)+1,e},{}),_=await c._.attendance.findMany({where:{checkInTime:t,checkOutTime:{not:null}},select:{checkInTime:!0,checkOutTime:!0}}),f=_.length>0?_.reduce((e,t)=>{let n=new Date(t.checkOutTime).getTime()-new Date(t.checkInTime).getTime();return e+n},0)/_.length:0,M=new Date,v=new Date(M.getFullYear(),M.getMonth(),M.getDate()),x=new Date(M.getFullYear(),M.getMonth(),M.getDate()+1),O=await c._.attendance.count({where:{checkInTime:{gte:v,lt:x},checkOutTime:null}});return o.NextResponse.json({period:a,dateRange:{start:t.gte.toISOString(),end:t.lt.toISOString()},summary:{totalVisits:p,activeVisitors:O,averageDuration:Math.round(f/6e4),completedVisits:_.length},dailyStats:h,hourlyStats:b,typeBreakdown:g.map(e=>({type:e.isVisitor?"Visitor":"Member",count:e._count.id})),topVisitors:D})}catch(e){return console.error("Get attendance stats error:",e),o.NextResponse.json({error:"Failed to fetch attendance statistics"},{status:500})}}let l=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/attendance/stats/route",pathname:"/api/attendance/stats",filename:"route",bundlePath:"app/api/attendance/stats/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\Library Project\\app\\api\\attendance\\stats\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:p}=l,h="/api/attendance/stats/route";function g(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}},2663:(e,t,n)=>{n.d(t,{_:()=>r});let a=require("@prisma/client"),r=globalThis.prisma??new a.PrismaClient({log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[948,972],()=>n(7654));module.exports=a})();