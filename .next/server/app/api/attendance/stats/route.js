"use strict";(()=>{var e={};e.id=11,e.ids=[11],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7654:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>h,patchFetch:()=>g,requestAsyncStorage:()=>u,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var a={};n.r(a),n.d(a,{GET:()=>d});var r=n(9303),i=n(8716),s=n(670),o=n(7070),c=n(2663);async function d(e){try{let t;let{searchParams:n}=new URL(e.url),a=n.get("period")||"week",r=n.get("startDate"),i=n.get("endDate"),s=new Date;if(r&&i)t={gte:new Date(r),lt:new Date(i)};else switch(a){case"week":let d=new Date(s);d.setDate(s.getDate()-7),t={gte:d,lt:s};break;case"month":let l=new Date(s);l.setMonth(s.getMonth()-1),t={gte:l,lt:s};break;case"year":let u=new Date(s);u.setFullYear(s.getFullYear()-1),t={gte:u,lt:s};break;default:let m=new Date(s);m.setDate(s.getDate()-7),t={gte:m,lt:s}}let p=await c._.attendance.count({where:{checkInTime:t}}),h=(await c._.attendance.groupBy({by:["checkInTime"],where:{checkInTime:t},_count:{id:!0},orderBy:{checkInTime:"asc"}})).reduce((e,t)=>{let n=new Date(t.checkInTime).toISOString().split("T")[0];return e[n]||(e[n]=0),e[n]+=t._count.id,e},{}),g=await c._.attendance.groupBy({by:["isVisitor"],where:{checkInTime:t},_count:{id:!0}}),w=await c._.attendance.groupBy({by:["personId","memberId"],where:{checkInTime:t,OR:[{personId:{not:null}},{memberId:{not:null}}]},_count:{id:!0},orderBy:{_count:{id:"desc"}},take:10}),I=w.filter(e=>e.personId).map(e=>e.personId),k=w.filter(e=>e.memberId).map(e=>e.memberId),[T,y]=await Promise.all([I.length>0?c._.person.findMany({where:{id:{in:I}},select:{id:!0,name:!0,email:!0,personType:!0}}):[],k.length>0?c._.member.findMany({where:{id:{in:k}},select:{id:!0,name:!0,email:!0}}):[]]),D=w.map(e=>{let t=T.find(t=>t.id===e.personId),n=y.find(t=>t.id===e.memberId);return{id:e.personId||e.memberId,name:t?.name||n?.name||"Unknown",email:t?.email||n?.email||"Unknown",type:t?.personType||"Member",visits:e._count.id}}),_=(await c._.attendance.findMany({where:{checkInTime:t},select:{checkInTime:!0}})).reduce((e,t)=>{let n=new Date(t.checkInTime).getHours();return e[n]=(e[n]||0)+1,e},{}),b=await c._.attendance.findMany({where:{checkInTime:t,checkOutTime:{not:null}},select:{checkInTime:!0,checkOutTime:!0}}),f=b.length>0?b.reduce((e,t)=>{let n=new Date(t.checkOutTime).getTime()-new Date(t.checkInTime).getTime();return e+n},0)/b.length:0,x=new Date,M=new Date(x.getFullYear(),x.getMonth(),x.getDate()),v=new Date(x.getFullYear(),x.getMonth(),x.getDate()+1),S=await c._.attendance.count({where:{checkInTime:{gte:M,lt:v},checkOutTime:null}});return o.NextResponse.json({period:a,dateRange:{start:t.gte.toISOString(),end:t.lt.toISOString()},summary:{totalVisits:p,activeVisitors:S,averageDuration:Math.round(f/6e4),completedVisits:b.length},dailyStats:h,hourlyStats:_,typeBreakdown:g.map(e=>({type:e.isVisitor?"Visitor":"Member",count:e._count.id})),topVisitors:D})}catch(e){return console.error("Get attendance stats error:",e),o.NextResponse.json({error:"Failed to fetch attendance statistics"},{status:500})}}let l=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/attendance/stats/route",pathname:"/api/attendance/stats",filename:"route",bundlePath:"app/api/attendance/stats/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\Library Project\\app\\api\\attendance\\stats\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:p}=l,h="/api/attendance/stats/route";function g(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}},2663:(e,t,n)=>{n.d(t,{_:()=>o});let a=require("@prisma/client"),r=globalThis,i=process.env.DATABASE_URL,s=i?`${i}?connection_limit=5&pool_timeout=20&connect_timeout=60`:i,o=r.prisma??new a.PrismaClient({log:["error"],datasources:{db:{url:s}}});process.on("beforeExit",async()=>{await o.$disconnect()}),process.on("SIGINT",async()=>{await o.$disconnect(),process.exit(0)}),process.on("SIGTERM",async()=>{await o.$disconnect(),process.exit(0)})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[948,972],()=>n(7654));module.exports=a})();