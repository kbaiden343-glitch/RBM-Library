"use strict";(()=>{var e={};e.id=11,e.ids=[11],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7654:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>p,patchFetch:()=>m,requestAsyncStorage:()=>u,routeModule:()=>s,serverHooks:()=>h,staticGenerationAsyncStorage:()=>l});var r={};n.r(r),n.d(r,{GET:()=>d});var a=n(9303),o=n(8716),i=n(670),c=n(7070);async function d(e){try{let t;let{searchParams:n}=new URL(e.url),r=n.get("period")||"week",a=n.get("startDate"),o=n.get("endDate"),i=new Date;if(a&&o)t={gte:new Date(a),lt:new Date(o)};else switch(r){case"week":let d=new Date(i);d.setDate(i.getDate()-7),t={gte:d,lt:i};break;case"month":let s=new Date(i);s.setMonth(i.getMonth()-1),t={gte:s,lt:i};break;case"year":let u=new Date(i);u.setFullYear(i.getFullYear()-1),t={gte:u,lt:i};break;default:let l=new Date(i);l.setDate(i.getDate()-7),t={gte:l,lt:i}}let h=await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).attendance.count({where:{checkInTime:t}}),p=(await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).attendance.groupBy({by:["checkInTime"],where:{checkInTime:t},_count:{id:!0},orderBy:{checkInTime:"asc"}})).reduce((e,t)=>{let n=new Date(t.checkInTime).toISOString().split("T")[0];return e[n]||(e[n]=0),e[n]+=t._count.id,e},{}),m=await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).attendance.groupBy({by:["isVisitor"],where:{checkInTime:t},_count:{id:!0}}),w=await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).attendance.groupBy({by:["personId"],where:{checkInTime:t,personId:{not:null}},_count:{id:!0},orderBy:{_count:{id:"desc"}},take:10}),O=w.filter(e=>e.personId).map(e=>e.personId),g=O.length>0?await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).person.findMany({where:{id:{in:O}},select:{id:!0,name:!0,email:!0,personType:!0}}):[],D=w.map(e=>{let t=g.find(t=>t.id===e.personId);return{id:e.personId,name:t?.name||"Unknown",email:t?.email||"Unknown",type:t?.personType||"Visitor",visits:e._count.id}}),b=(await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).attendance.findMany({where:{checkInTime:t},select:{checkInTime:!0}})).reduce((e,t)=>{let n=new Date(t.checkInTime).getHours();return e[n]=(e[n]||0)+1,e},{}),T=await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).attendance.findMany({where:{checkInTime:t,checkOutTime:{not:null}},select:{checkInTime:!0,checkOutTime:!0}}),f=T.length>0?T.reduce((e,t)=>{let n=new Date(t.checkOutTime).getTime()-new Date(t.checkInTime).getTime();return e+n},0)/T.length:0,k=new Date,_=new Date(k.getFullYear(),k.getMonth(),k.getDate()),U=new Date(k.getFullYear(),k.getMonth(),k.getDate()+1),y=await Object(function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).attendance.count({where:{checkInTime:{gte:_,lt:U},checkOutTime:null}});return c.NextResponse.json({period:r,dateRange:{start:t.gte.toISOString(),end:t.lt.toISOString()},summary:{totalVisits:h,activeVisitors:y,averageDuration:Math.round(f/6e4),completedVisits:T.length},dailyStats:p,hourlyStats:b,typeBreakdown:m.map(e=>({type:e.isVisitor?"Visitor":"Member",count:e._count.id})),topVisitors:D})}catch(e){return console.error("Get attendance stats error:",e),c.NextResponse.json({error:"Failed to fetch attendance statistics"},{status:500})}}!function(){var e=Error("Cannot find module '../../../lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let s=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/attendance/stats/route",pathname:"/api/attendance/stats",filename:"route",bundlePath:"app/api/attendance/stats/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\Library Project\\app\\api\\attendance\\stats\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:l,serverHooks:h}=s,p="/api/attendance/stats/route";function m(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:l})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[948,972],()=>n(7654));module.exports=r})();