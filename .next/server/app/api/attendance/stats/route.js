"use strict";(()=>{var e={};e.id=11,e.ids=[11],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7654:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>h,patchFetch:()=>g,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var a={};n.r(a),n.d(a,{GET:()=>l});var r=n(9303),i=n(8716),s=n(670),c=n(7070),o=n(2663);async function l(e){try{let t;let{searchParams:n}=new URL(e.url),a=n.get("period")||"week",r=n.get("startDate"),i=n.get("endDate"),s=new Date;if(r&&i)t={gte:new Date(r),lt:new Date(i)};else switch(a){case"week":let l=new Date(s);l.setDate(s.getDate()-7),t={gte:l,lt:s};break;case"month":let u=new Date(s);u.setMonth(s.getMonth()-1),t={gte:u,lt:s};break;case"year":let d=new Date(s);d.setFullYear(s.getFullYear()-1),t={gte:d,lt:s};break;default:let p=new Date(s);p.setDate(s.getDate()-7),t={gte:p,lt:s}}let m=await o._.attendance.count({where:{checkInTime:t}}),h=(await o._.attendance.groupBy({by:["checkInTime"],where:{checkInTime:t},_count:{id:!0},orderBy:{checkInTime:"asc"}})).reduce((e,t)=>{let n=new Date(t.checkInTime).toISOString().split("T")[0];return e[n]||(e[n]=0),e[n]+=t._count.id,e},{}),g=await o._.attendance.groupBy({by:["isVisitor"],where:{checkInTime:t},_count:{id:!0}}),w=await o._.attendance.groupBy({by:["personId"],where:{checkInTime:t,personId:{not:null}},_count:{id:!0},orderBy:{_count:{id:"desc"}},take:10}),k=w.filter(e=>e.personId).map(e=>e.personId),T=k.length>0?await o._.person.findMany({where:{id:{in:k}},select:{id:!0,name:!0,email:!0,personType:!0}}):[],D=w.map(e=>{let t=T.find(t=>t.id===e.personId);return{id:e.personId,name:t?.name||"Unknown",email:t?.email||"Unknown",type:t?.personType||"Visitor",visits:e._count.id}}),_=(await o._.attendance.findMany({where:{checkInTime:t},select:{checkInTime:!0}})).reduce((e,t)=>{let n=new Date(t.checkInTime).getHours();return e[n]=(e[n]||0)+1,e},{}),y=await o._.attendance.findMany({where:{checkInTime:t,checkOutTime:{not:null}},select:{checkInTime:!0,checkOutTime:!0}}),I=y.length>0?y.reduce((e,t)=>{let n=new Date(t.checkOutTime).getTime()-new Date(t.checkInTime).getTime();return e+n},0)/y.length:0,b=new Date,f=new Date(b.getFullYear(),b.getMonth(),b.getDate()),v=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1),S=await o._.attendance.count({where:{checkInTime:{gte:f,lt:v},checkOutTime:null}});return c.NextResponse.json({period:a,dateRange:{start:t.gte.toISOString(),end:t.lt.toISOString()},summary:{totalVisits:m,activeVisitors:S,averageDuration:Math.round(I/6e4),completedVisits:y.length},dailyStats:h,hourlyStats:_,typeBreakdown:g.map(e=>({type:e.isVisitor?"Visitor":"Member",count:e._count.id})),topVisitors:D})}catch(e){return console.error("Get attendance stats error:",e),c.NextResponse.json({error:"Failed to fetch attendance statistics"},{status:500})}}let u=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/attendance/stats/route",pathname:"/api/attendance/stats",filename:"route",bundlePath:"app/api/attendance/stats/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\Library Project\\app\\api\\attendance\\stats\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:m}=u,h="/api/attendance/stats/route";function g(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}},2663:(e,t,n)=>{let a;n.d(t,{_:()=>a});let r=require("@prisma/client"),i=globalThis,s=process.env.DATABASE_URL||process.env.POSTGRES_URL||process.env.POSTGRES_PRISMA_URL,c=s?`${s}?connection_limit=1&pool_timeout=20&connect_timeout=60&schema=public&pgbouncer=true&prepared_statements=false`:s;try{a=i.prisma??new r.PrismaClient({log:["error"],datasources:{db:{url:c}}})}catch(e){console.warn("Prisma client not available, using fallback:",e),a={}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[948,972],()=>n(7654));module.exports=a})();