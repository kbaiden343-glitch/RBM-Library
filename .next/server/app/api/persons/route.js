"use strict";(()=>{var e={};e.id=824,e.ids=[824],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2954:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>S,patchFetch:()=>T,requestAsyncStorage:()=>x,routeModule:()=>f,serverHooks:()=>R,staticGenerationAsyncStorage:()=>P});var s={};t.r(s),t.d(s,{GET:()=>y,POST:()=>w});var n=t(9303),a=t(8716),o=t(670),i=t(7070),l=t(2663);let u=e=>{let r=Math.pow(10,e-1);return Math.floor(Math.random()*(Math.pow(10,e)-1-r+1)+r).toString()},p=()=>{let e=new Date().getFullYear(),r=u(6).padStart(6,"0");return`SPL-${e}-${r}`},c=()=>{let e=new Date().getFullYear(),r=u(4);return`SPL-${e}-V-${r}`},d=()=>{let e=new Date().getFullYear(),r=u(4);return`SPL-${e}-ST-${r}`},m=()=>{let e=new Date().getFullYear(),r=u(3);return`SPL-${e}-VIP-${r}`},h=()=>{let e=new Date().getFullYear(),r=u(3);return`SPL-${e}-STF-${r}`},g=e=>{switch(e.toUpperCase()){case"MEMBER":return p();case"VISITOR":default:return c();case"STUDENT":return d();case"VIP":return m();case"STAFF":return h()}};async function y(e){try{let{searchParams:r}=new URL(e.url),t=parseInt(r.get("page")||"1"),s=parseInt(r.get("limit")||"50"),n=r.get("search")||"",a=r.get("personType")||"",o=r.get("status")||"",u=(t-1)*s,p={};n&&(p.OR=[{name:{contains:n,mode:"insensitive"}},{email:{contains:n,mode:"insensitive"}},{phone:{contains:n,mode:"insensitive"}}]),a&&"all"!==a&&(p.personType=a),o&&"all"!==o&&(p.status=o);let[c,d]=await Promise.all([l._.person.findMany({where:p,skip:u,take:s,orderBy:{createdAt:"desc"}}),l._.person.count({where:p})]);return i.NextResponse.json({persons:c,pagination:{page:t,limit:s,total:d,pages:Math.ceil(d/s)}})}catch(e){return console.error("Get persons error:",e),i.NextResponse.json({error:"Failed to fetch persons"},{status:500})}}async function w(e){try{let{name:r,email:t,phone:s,address:n,personType:a,notes:o,emergencyContact:u}=await e.json();if(!r||!t)return i.NextResponse.json({error:"Name and email are required"},{status:400});let[p,c]=await Promise.all([l._.person.findUnique({where:{email:t}}),l._.member.findUnique({where:{email:t}}).catch(()=>null)]);if(p)return i.NextResponse.json({error:`A ${p.personType.toLowerCase()} with email "${t}" already exists`,details:`Person: ${p.name} (${p.libraryId||"No ID"})`},{status:409});if(c)return i.NextResponse.json({error:`A member with email "${t}" already exists in the legacy system`,details:`Member: ${c.name}`},{status:409});let d=g(a||"VISITOR"),m=await l._.person.create({data:{libraryId:d,name:r,email:t,phone:s||null,address:n||null,personType:a||"VISITOR",notes:o||null,emergencyContact:u||null,membershipDate:"MEMBER"===a?new Date:null}});return console.log("Person created successfully:",{id:m.id,name:m.name,email:m.email,libraryId:m.libraryId,personType:m.personType}),i.NextResponse.json(m,{status:201})}catch(e){if(console.error("Create person error:",e),e instanceof Error){if(e.message.includes("Unique constraint failed"))return i.NextResponse.json({error:"A person with this email or library ID already exists"},{status:409});if(e.message.includes("libraryId"))return i.NextResponse.json({error:"Library ID field is not available. Please contact system administrator."},{status:500})}return i.NextResponse.json({error:"Failed to create person",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/persons/route",pathname:"/api/persons",filename:"route",bundlePath:"app/api/persons/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\Library Project\\app\\api\\persons\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:P,serverHooks:R}=f,S="/api/persons/route";function T(){return(0,o.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:P})}},2663:(e,r,t)=>{t.d(r,{_:()=>n});let s=require("@prisma/client"),n=globalThis.prisma??new s.PrismaClient({log:["error"]})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,972],()=>t(2954));module.exports=s})();